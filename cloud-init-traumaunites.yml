#cloud-config

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ (WordPress ÑƒÐ¶Ðµ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)
package_update: true
packages:
  - git
  - curl
  - unzip
  - wget
  - ufw

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
users:
  - name: traumaunites
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    home: /home/traumaunites

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (root Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼)
chpasswd:
  list: |
    traumaunites:TraumaUnites2024!
  expire: false

# ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
runcmd:
  # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
  - mkdir -p /var/www/traumaunites
  - chown -R traumaunites:traumaunites /var/www/traumaunites
  - chmod -R 755 /var/www/traumaunites
  
  # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¸Ð· GitHub
  - cd /var/www/traumaunites
  - git clone https://github.com/AlexandrNemkov/traumaunites-wordpress.git .
  
  # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ Ð² WordPress
  - cp -r /var/www/traumaunites/wordpress/wp-content/themes/traumaunites /var/www/html/wp-content/themes/
  - chown -R www-data:www-data /var/www/html/wp-content/themes/traumaunites
  - chmod -R 755 /var/www/html/wp-content/themes/traumaunites
  
  # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
  - find /var/www/traumaunites -type d -exec chmod 755 {} \;
  - find /var/www/traumaunites -type f -exec chmod 644 {} \;
  - chmod +x /var/www/traumaunites/start-dev.sh
  
  # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ firewall
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‚ÐµÐ¼Ñ‹ TraumaUnites
write_files:
  # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ñ‚ÐµÐ¼Ñ‹ TraumaUnites
  - path: /home/traumaunites/setup-traumaunites.sh
    owner: traumaunites:traumaunites
    permissions: '755'
    content: |
      #!/bin/bash
      
      echo "ðŸ¥ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° TraumaUnites Ñ‚ÐµÐ¼Ñ‹..."
      
      # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ WordPress
      cd /var/www/html
      
      # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ WP-CLI ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
      if ! command -v wp &> /dev/null; then
          curl -O https://raw.githubusercontent.com/wp-cli/wp-cli/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
      fi
      
      # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐ¼Ñƒ TraumaUnites
      sudo -u www-data wp theme activate traumaunites
      
      # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ðµ ÑÑÑ‹Ð»ÐºÐ¸
      sudo -u www-data wp rewrite structure '/%postname%/'
      sudo -u www-data wp rewrite flush
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
      sudo -u www-data wp post create --post_type=page --post_title="About Us" --post_name="about" --post_status=publish --porcelain || echo "Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° About Us ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
      sudo -u www-data wp post create --post_type=page --post_title="Services" --post_name="services" --post_status=publish --porcelain || echo "Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Services ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
      sudo -u www-data wp post create --post_type=page --post_title="Contact" --post_name="contact" --post_status=publish --porcelain || echo "Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Contact ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
      
      echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ‚ÐµÐ¼Ñ‹ TraumaUnites Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
      echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://$(curl -s ifconfig.me)"
      echo "ðŸ‘¤ ÐÐ´Ð¼Ð¸Ð½ÐºÐ°: http://$(curl -s ifconfig.me)/wp-admin"

# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
runcmd:
  # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‚ÐµÐ¼Ñ‹ TraumaUnites
  - /bin/bash /home/traumaunites/setup-traumaunites.sh
  
  # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ðµ
  - echo "TraumaUnites Theme Setup Complete!" > /var/www/traumaunites/server-info.txt
  - echo "Server IP: $(curl -s ifconfig.me)" >> /var/www/traumaunites/server-info.txt
  - echo "WordPress Admin URL: http://$(curl -s ifconfig.me)/wp-admin" >> /var/www/traumaunites/server-info.txt
  - echo "Theme: TraumaUnites activated" >> /var/www/traumaunites/server-info.txt
  - echo "Project Path: /var/www/traumaunites" >> /var/www/traumaunites/server-info.txt
  - echo "Theme Path: /var/www/html/wp-content/themes/traumaunites" >> /var/www/traumaunites/server-info.txt
