#cloud-config

# Обновляем систему и устанавливаем дополнительные пакеты (WordPress уже предустановлен)
package_update: true
packages:
  - git
  - curl
  - unzip
  - wget
  - ufw

# Создаем пользователя для проекта
users:
  - name: traumaunites
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    home: /home/traumaunites

# Настраиваем пароль только для пользователя проекта (root не трогаем)
chpasswd:
  list: |
    traumaunites:TraumaUnites2024!
  expire: false

# Команды для выполнения после установки пакетов
runcmd:
  # Создаем директории для проекта
  - mkdir -p /var/www/traumaunites
  - chown -R traumaunites:traumaunites /var/www/traumaunites
  - chmod -R 755 /var/www/traumaunites
  
  # Клонируем проект из GitHub
  - cd /var/www/traumaunites
  - git clone https://github.com/AlexandrNemkov/traumaunites-wordpress.git .
  
  # Копируем кастомную тему в WordPress
  - cp -r /var/www/traumaunites/wordpress/wp-content/themes/traumaunites /var/www/html/wp-content/themes/
  - chown -R www-data:www-data /var/www/html/wp-content/themes/traumaunites
  - chmod -R 755 /var/www/html/wp-content/themes/traumaunites
  
  # Настраиваем права доступа
  - find /var/www/traumaunites -type d -exec chmod 755 {} \;
  - find /var/www/traumaunites -type f -exec chmod 644 {} \;
  - chmod +x /var/www/traumaunites/start-dev.sh
  
  # Настраиваем firewall
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

# Создаем скрипт для настройки темы TraumaUnites
write_files:
  # Скрипт для активации темы TraumaUnites
  - path: /home/traumaunites/setup-traumaunites.sh
    owner: traumaunites:traumaunites
    permissions: '755'
    content: |
      #!/bin/bash
      
      echo "🏥 Настройка TraumaUnites темы..."
      
      # Переходим в директорию WordPress
      cd /var/www/html
      
      # Скачиваем WP-CLI если его нет
      if ! command -v wp &> /dev/null; then
          curl -O https://raw.githubusercontent.com/wp-cli/wp-cli/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
      fi
      
      # Активируем тему TraumaUnites
      sudo -u www-data wp theme activate traumaunites
      
      # Настраиваем постоянные ссылки
      sudo -u www-data wp rewrite structure '/%postname%/'
      sudo -u www-data wp rewrite flush
      
      # Создаем необходимые страницы если их нет
      sudo -u www-data wp post create --post_type=page --post_title="About Us" --post_name="about" --post_status=publish --porcelain || echo "Страница About Us уже существует"
      sudo -u www-data wp post create --post_type=page --post_title="Services" --post_name="services" --post_status=publish --porcelain || echo "Страница Services уже существует"
      sudo -u www-data wp post create --post_type=page --post_title="Contact" --post_name="contact" --post_status=publish --porcelain || echo "Страница Contact уже существует"
      
      echo "✅ Настройка темы TraumaUnites завершена!"
      echo "🌐 Сайт доступен по адресу: http://$(curl -s ifconfig.me)"
      echo "👤 Админка: http://$(curl -s ifconfig.me)/wp-admin"

# Финальные команды
runcmd:
  # Выполняем скрипт настройки темы TraumaUnites
  - /bin/bash /home/traumaunites/setup-traumaunites.sh
  
  # Создаем файл с информацией о сервере
  - echo "TraumaUnites Theme Setup Complete!" > /var/www/traumaunites/server-info.txt
  - echo "Server IP: $(curl -s ifconfig.me)" >> /var/www/traumaunites/server-info.txt
  - echo "WordPress Admin URL: http://$(curl -s ifconfig.me)/wp-admin" >> /var/www/traumaunites/server-info.txt
  - echo "Theme: TraumaUnites activated" >> /var/www/traumaunites/server-info.txt
  - echo "Project Path: /var/www/traumaunites" >> /var/www/traumaunites/server-info.txt
  - echo "Theme Path: /var/www/html/wp-content/themes/traumaunites" >> /var/www/traumaunites/server-info.txt
